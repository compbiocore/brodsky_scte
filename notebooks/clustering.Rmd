---
title: "scTE analysis"
author: "August Guang"
output:
    bookdown::html_document2:
        toc: true
    bookdown::pdf_document2:
        keep_tex: true
    bookdown::word_document2:
        toc:true
bibliography: "analysis.bib"
---

# AB-1 thru AB-6: COL7 cancer cells

Setup: 10 patients, 34 samples, mapping of OA (patients) to P (samples)

```{r install_commands, include=FALSE, eval=FALSE}
#If the packages aren't installed already, the below commands can be run to install everything.
if (!requireNamespace("BiocManager", quietly = TRUE)) install.packages("BiocManager")

install.packages(tidyverse)
BiocManager::install('multtest')
install.packages('metap')
install.packages("msigdbr")
```

```{r rna_setup, include=FALSE}
library(tidyverse)
library(ggplot2)
library(future)
library(parallel)
library(Seurat)
library(repr)
library(patchwork)
PATH="/Users/aguang/CORE/ianwong/scte"
#DATAPATH=file.path(PATH,"results/01_cellranger-count")
SPATH=file.path(PATH,"results")
#TABLEPATH=file.path(PATH,"tables")
plan("multisession", workers=4) # 4 threads
options(future.globals.maxSize = 2000 * 1024^2) # future options

raw_data <- read.csv(file=file.path(PATH,"merged_counts.csv"))
barcodes <- raw_data$barcodes
barcodes <- barcodes[2:length(barcodes)]
cps <- strsplit(barcodes, split="_")
patients <- sapply(cps, "[[", 2)
samples <- sapply(cps, "[[", 3)
cps_df <- data.frame(Patients=patients,Samples=samples, row.names=barcodes)

counts <- raw_data[2:nrow(raw_data),2:ncol(raw_data)]
rownames(counts) <- barcodes
counts <- as.matrix(counts) %>% t
sobj <- CreateSeuratObject(counts=counts,min.cells=3,min.features=200,names.field=2,names.delim="_",meta.data=cps_df)

rmsk <- read_delim("/Users/aguang/CORE/ianwong/brodsky_scte/rmsk.txt", col_names=FALSE)
#sct.combined <- readRDS(file.path(SPATH,"sct.combined.rds"))
#saveRDS(sct.combined,file=file.path(SPATH,"sct.combined.rds"))
#saveRDS(obj_sub,file=file.path(SPATH,"obj_sub.rds"))
```

# Preprocessing and QC

First we look at the number of cells in each sample.

```{r overview, echo=FALSE}
sobj[["percent.mt"]] <- PercentageFeatureSet(sobj,pattern="^MT-")
sapply(obj, function(x) table(x$orig.ident))
```

The number of cells are suspiciously even.

```{r violin-nfeat, echo=FALSE, fig.cap="Violin plot of number of features."}
VlnPlot(sobj, features="nFeature_RNA") + theme(legend.position = "none")
```

For Figure \@ref(fig:violin-nfeat) the distribution is a lot more spread out than would expect if the features were just genes. However since the features are genes and transposable elements combined, not sure if distribution should look different. Will leave alone.

```{r violin-ncount, echo=FALSE, fig.cap="Violin plot of number of counts."}
VlnPlot(sobj, features="nCount_RNA") + theme(legend.position = "none")
```

The nCount violin (Figure \@ref(fig:violin-ncount)) looks fine.

```{r violin-mito, echo=FALSE, fig.cap="Violin plot of mitochondrial percentage"}
VlnPlot(sobj, features="percent.mt") + theme(legend.position = "none")
```

From Figure \@ref(fig:violin-mito) seems we find no mitochondrial DNA using the pattern `^MT-`. Some features do show up as "MT.ND1" or "MT.CO3" on doing a search for just "MT", but not sure if they are actually mitochondrial genes although a google search shows that they might be. Code line would be: `rownames(sobj@assays$RNA)[rownames(sobj@assays$RNA) %>% grep("MT", .)]`. We will do another search thus using the pattern `^MT\\.` since we think they must be mitochondrial genes.

```{r mito2, echo=FALSE, fig.cap="Violin plot of mitochondrial percentage using ^MT\\."}
sobj[["percent.mtdot"]] <- PercentageFeatureSet(sobj,pattern="^MT\\.")
VlnPlot(sobj, features="percent.mtdot") + theme(legend.position = "none")
```

There are of course cells that have counts in these "MT." genes, so we do see a plot that has more than just 0 counts here (Figure \@ref(fig:mito2))

```{r feat, echo=FALSE, fig.cap="Scatter plot of counts vs number of features."}
FeatureScatter(sobj, feature1 = "nCount_RNA", feature2 = "nFeature_RNA") + theme(legend.position = "none")
```

The counts vs number of features scatter (Figure \@ref(fig:feat)) looks fine.

```{r feat-vs-mito, echo=FALSE, fig.cap="Scatter plot of counts vs percentage of mitochondrial DNA"}
FeatureScatter(sobj, feature1 = "nCount_RNA", feature2 = "percent.mtdot") + theme(legend.position = "none")
```

Figure \@ref(fig:feat-vs-mito) actually provides some confidence that the "MT." genes are mitochondrial since we get this L-shaped graph. Would filer out cells with over 5% mitochondrial counts.

## How many cells do we filter out this way?

```{r subset, echo=FALSE}
obj_sub <- subset(sobj, subset = nFeature_RNA < 22000 & nFeature_RNA > 1000 & nCount_RNA < 2e+06 & nCount_RNA > 1000 & percent.mtdot < 5)
table(obj_sub$orig.ident)/table(sobj$orig.ident)
```

The set of data had `r nrow(sobj@assays$RNA)` features across `r table(sobj$orig.ident)` samples. After subsetting, we have `r nrow(obj_sub@assays$RNA)` features across `r table(obj_sub$orig.ident)` samples. So a reduction of around 10 cells each.

# clustering

## clustering on gene+TE matrix without integration

We will use sctransform [@Hafemeister2019] rather than `NormalizeData(), ScaleData(), FindVariableFeatures()`.

```{r sctransform, eval=FALSE, include=FALSE}
sct <- SCTransform(obj_sub, vars.to.regress = "percent.mtdot", verbose=FALSE)
```

```{r pca, eval=FALSE, include=FALSE}
sct <- RunPCA(sct, verbose = FALSE)
sct <- RunUMAP(sct, reduction = "pca", dims = 1:30)
sct <- FindNeighbors(sct, reduction = "pca", dims = 1:30)
sct <- FindClusters(sct, resolution = 0.2)
```

Resolution is set very low, at 0.2 because there are so few cells. However this still reveals a lot of clusters.

```{r dimplot-reg, echo=FALSE, fig.cap="UMAP colored by cluster ID for gene+TE matrix without integration."}
DimPlot(sct, reduction = "umap")
```

The UMAP plot (Figure \@ref(fig:dimplot-reg)) looks pretty bad. Our hypothesis is that this is due to the inclusion of TE to the matrix in addition to the genes. Could also be that the data should be integrated instead of merged, but more likely need to cluster on just the genes.

## clustering on gene+TE matrix with integration

```{r integrate, eval=FALSE, include=FALSE}
obj_spl <- SplitObject(obj_sub)
sct_spl <- lapply(obj_spl, function(x) SCTransform(x, vars.to.regress = "percent.mtdot", verbose=FALSE))
features <- SelectIntegrationFeatures(object.list = sct_spl, nfeatures = 3000)
sct_spl <- PrepSCTIntegration(object.list = sct_spl, anchor.features = features)
sct.anchors <- FindIntegrationAnchors(object.list = sct_spl, normalization.method = "SCT",
    anchor.features = features)

# https://github.com/satijalab/seurat/issues/3930
# IntegrateData needs kweight adjusted down when cell count less than 100, which is the case for AB-2
sct.combined <- IntegrateData(anchorset = sct.anchors, k.weight=80, normalization.method = "SCT")
```

```{r clust-genete, eval=FALSE, echo=FALSE}
sct.combined <- RunPCA(sct.combined, verbose = FALSE)
sct.combined <- RunUMAP(sct.combined, reduction = "pca", dims = 1:30)
sct.combined <- FindNeighbors(sct.combined, reduction = "pca", dims = 1:30)
sct.combined <- FindClusters(sct.combined, resolution = 0.2)
```

```{r umap-genete, echo=FALSE}
DimPlot(sct.combined, reduction = "umap")
```

We can see that the UMAP for the integrated dataset does not look much different (Figure \@ref(fig:umap-genete)), although it does appear that there are more clusters with multiple cells than without merging, where there was really only cluster 0 that had any significant number of cells. Points to integration being useful but not the reason for all these tiny clusters.

## clustering on just gene matrix with integration

```{r filter, eval=FALSE, echo=FALSE}
features <- rownames(obj_sub@assays$RNA)
rmsk_subbed <- gsub("_","-",rmsk$X11)
tes <- which(features %in% rmsk_subbed)
moretes <- grep("^X\\.", features)
gene_mat <- obj_sub@assays$RNA[-c(moretes,tes),]
gobj <- CreateSeuratObject(counts=gene_mat,min.cells=3,min.features=200,names.field=2,names.delim="_",meta.data=cps_df)

gobj_spl <- SplitObject(gobj)
gobj_spl <- lapply(gobj_spl, function(x) SCTransform(x, verbose=FALSE))
gobj_features <- SelectIntegrationFeatures(object.list = gobj_spl, nfeatures = 3000)
gobj_spl <- PrepSCTIntegration(object.list = gobj_spl, anchor.features = gobj_features)
gobj.anchors <- FindIntegrationAnchors(object.list = gobj_spl, normalization.method = "SCT",
    anchor.features = gobj_features)

# https://github.com/satijalab/seurat/issues/3930
# IntegrateData needs kweight adjusted down when cell count less than 100, which is the case for AB-2
gobj.combined <- IntegrateData(anchorset = gobj.anchors, k.weight=80, normalization.method = "SCT")
```

We have to filter out the TE from the matrix to get just the genes. There is a file called `rmsk.txt` where we will use the info in column11 to do the filtering. Any features with `(nnnnnn)n` got read in as `X.nnnnn.n` however, so for those we will just filter if the pattern matches `^X\\.` We also have to substitute "_" with "-" from `rmsk$X11` because they got converted to dashes in Seurat since it doesn't allow underscores.

```{r clust-gene, eval=FALSE, echo=FALSE}
gobj.combined <- RunPCA(gobj.combined, verbose = FALSE)
gobj.combined <- RunUMAP(gobj.combined, reduction = "pca", dims = 1:30)
gobj.combined <- FindNeighbors(gobj.combined, reduction = "pca", dims = 1:30)
gobj.combined <- FindClusters(gobj.combined, resolution = 0.2)
#saveRDS(gobj.combined,file=file.path(SPATH,"gobj.combined.rds"))
```

```{r umap-gene, echo=FALSE}
DimPlot(gobj.combined, reduction = "umap")
```
